# CS 스터디 요약 - 8주차

## 주제: 데이터베이스 인덱스 및 SQL 인젝션

### 1. 인덱스(Index)

#### 기본 개념
- **정의**: 데이터를 쉽게 찾기 위한 색인 역할
- **원리**: 키-벨류 형태로 저장되어 옵티마이저가 빠르게 읽을 수 있음
- **알고리즘**: B-Tree 알고리즘 사용

#### 인덱스가 빠른 이유
- 인덱스는 B-Tree 구조로 저장됨
- 이진 탐색(Binary Search) 방식으로 데이터 접근
  - 예: 1~100 범위에서 50으로 시작 → 75 → 62... 식으로 범위 좁혀감
- 전체 테이블 스캔(Full Scan)보다 효율적

#### 인덱스 종류
1. **단일 인덱스**: 하나의 컬럼에만 인덱스 설정
2. **복합 인덱스**: 여러 개의 컬럼에 인덱스 설정
3. **커버링 인덱스**: WHERE, FROM, ORDER BY 절 등 쿼리에 필요한 모든 컬럼 포함

#### 인덱스 설정 기준
- 쿼리에서 자주 사용되는 컬럼에 설정
- 모든 컬럼에 인덱스를 걸면 안됨
  - 옵티마이저가 어떤 인덱스를 사용할지 헷갈림
  - 선택 비용 증가

#### 인덱스 설정 시 주의사항
- **무분별한 인덱스 설정 금지**
  - 인덱스가 필요 없는 부분까지 인덱스 생성
  - 역설적으로 읽기 성능 저하 가능
  - 많은 인덱스는 옵티마이저의 선택 비용 증가

#### 실제 경험 사례
- 조직 조회 API 설계 시 발생한 문제 인지
- 과도하게 많은 부분에서 인덱스가 설정되어 성능 저하 경험

---

### 2. SQL 인젝션(SQL Injection)

#### 기본 개념
- SQL을 악의적으로 주입하여 공격하는 기법
- 보안 취약점으로 인한 데이터 유출 및 무단 접근 가능

#### 공격 원리
**예시: 로그인 시나리오**
```
정상: SELECT * FROM users WHERE id='input_id' AND password='input_pwd'

인젝션: 
입력 - id: ' OR '1'='1  (패스워드 입력 안함)
결과: SELECT * FROM users WHERE id='' OR '1'='1' AND password='...'
→ '1'='1'은 항상 참이므로 로그인 성공
```

- 원래는 쿼리 구조가 외부 입력으로 변조되지 않음
- SQL 인젝션은 외부 입력을 통해 쿼리 구조 변조 가능
- 패스워드 부분을 주석(`--`) 처리하여 우회

#### 방어 방법

##### 1. Prepared Statement (권장)
- **MyBatis 문법**
  - `#{parameter}`: Prepared Statement (안전) ✅
  - `${parameter}`: String Concatenation (위험) ❌

**Prepared Statement의 동작 원리**
1. 쿼리 구조를 먼저 파싱 및 컴파일
2. 실행 계획을 캐싱
3. 요청마다 파라미터만 주입하여 실행

**성능상 이점**
```
일반 Statement (매 요청마다):
파싱 → 컴파일 → 최적화 → 실행

Prepared Statement:
파싱 → 컴파일 (최초 1회) → 캐싱
이후 요청: 캐싱된 실행 계획 + 파라미터 주입만 수행
```

##### 2. 기타 방법
- JPA 사용
- 입력값 검증 및 이스케이프 처리

---

### 3. 인덱스와 Prepared Statement의 연결성

#### 면접 단골 질문
인덱스 → SQL 인젝션 → Prepared Statement 순으로 연결되어 묻는 경향
- 인덱스가 뭐냐? → SQL 인젝션이 뭐냐? → Prepared Statement 장점?

#### 학습 포인트
**암기가 아닌 이해의 중요성**
- 단순 정의만 아는 것이 아닌 연관성 이해 필요
- 각 개념이 왜 필요한지, 어떻게 연결되는지 파악

---

### 4. 추가 논의 사항

#### Prepared Statement의 컴파일 이점
- `Prepare` 단어에서 유추 가능: "미리 준비된" 상태
- 쿼리 자체는 1회만 파싱/컴파일
- 매 요청마다 파라미터만 변경하여 주입
- 별도 파싱 과정 필요 없어 성능 향상

#### 옵티마이저(Optimizer)
- 데이터베이스가 쿼리 실행 계획을 수립하는 엔진
- CPU 사용량과 디스크 IO를 고려하여 최적의 실행 계획 결정
- EXPLAIN으로 실행 계획 확인 가능

---

## 핵심 정리

| 항목 | 내용 |
|------|------|
| 인덱스 설정 | 쿼리 자주 사용 컬럼, 선택적으로 설정 |
| 인덱스 종류 | 단일, 복합, 커버링 |
| 주의사항 | 무분별한 설정 금지, 읽기 성능 저하 위험 |
| SQL 인젝션 | 악의적 SQL 주입으로 인한 보안 위협 |
| 방어법 | Prepared Statement 필수 사용 |
| MyBatis | `#{param}` 사용 (Prepared Statement) |
